<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics & Reports - FastBus Admin</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #8b5cf6;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --dark: #1e293b;
            --light: #f8fafc;
            --gray: #64748b;
            --border: #e2e8f0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 24px;
            border-radius: 12px;
            margin-bottom: 24px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 16px;
        }

        .header h1 {
            color: var(--dark);
            font-size: 28px;
        }

        .header-actions {
            display: flex;
            gap: 12px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
            font-weight: 500;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-secondary {
            background: var(--gray);
            color: white;
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .date-filter {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 24px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .date-filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 16px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .filter-group label {
            font-size: 12px;
            color: var(--gray);
            font-weight: 500;
        }

        .filter-group input,
        .filter-group select {
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 14px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .stat-card h3 {
            font-size: 14px;
            color: var(--gray);
            margin-bottom: 8px;
        }

        .stat-card .value {
            font-size: 32px;
            font-weight: 700;
            color: var(--dark);
        }

        .stat-card .sub-value {
            font-size: 14px;
            color: var(--gray);
            margin-top: 4px;
        }

        .stat-card.growth-positive .value {
            color: var(--success);
        }

        .stat-card.growth-negative .value {
            color: var(--danger);
        }

        .card {
            background: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 24px;
        }

        .card h2 {
            color: var(--dark);
            font-size: 20px;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--border);
        }

        .card h3 {
            color: var(--dark);
            font-size: 18px;
            margin-bottom: 16px;
        }

        .two-column {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 24px;
        }

        .route-list, .operator-list {
            list-style: none;
        }

        .route-item, .operator-item {
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .route-item:hover, .operator-item:hover {
            background: var(--light);
        }

        .route-info, .operator-info {
            flex: 1;
        }

        .route-name, .operator-name {
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 4px;
        }

        .route-stats, .operator-stats {
            font-size: 13px;
            color: var(--gray);
        }

        .route-revenue, .operator-revenue {
            font-size: 18px;
            font-weight: 700;
            color: var(--primary);
        }

        .chart-placeholder {
            background: var(--light);
            border: 2px dashed var(--border);
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            color: var(--gray);
            margin-bottom: 16px;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 16px;
        }

        .data-table thead {
            background: var(--light);
        }

        .data-table th,
        .data-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        .data-table th {
            font-weight: 600;
            color: var(--dark);
            font-size: 14px;
        }

        .data-table td {
            font-size: 14px;
            color: var(--gray);
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: var(--gray);
        }

        .spinner {
            border: 3px solid var(--border);
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .alert {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .alert.error {
            background: #fee2e2;
            color: var(--danger);
            border: 1px solid #fecaca;
        }

        .alert.success {
            background: #d1fae5;
            color: var(--success);
            border: 1px solid #a7f3d0;
        }

        .export-section {
            padding-top: 16px;
            border-top: 1px solid var(--border);
        }

        .badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }

        .badge-primary {
            background: #dbeafe;
            color: #1e40af;
        }

        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }

            .two-column {
                grid-template-columns: 1fr;
            }

            .date-filter-grid {
                grid-template-columns: 1fr;
            }

            .data-table {
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ðŸ“Š Analytics & Reports</h1>
            <div class="header-actions">
                <a href="admin-dashboard.html" class="btn btn-secondary">Dashboard</a>
                <button onclick="logout()" class="btn btn-secondary">Logout</button>
            </div>
        </div>

        <div id="alert" class="alert"></div>

        <!-- Date Filter -->
        <div class="date-filter">
            <div class="date-filter-grid">
                <div class="filter-group">
                    <label>Date From</label>
                    <input type="date" id="dateFrom">
                </div>
                <div class="filter-group">
                    <label>Date To</label>
                    <input type="date" id="dateTo">
                </div>
                <div class="filter-group">
                    <label>Quick Select</label>
                    <select id="quickSelect" onchange="applyQuickSelect()">
                        <option value="">Custom Range</option>
                        <option value="7">Last 7 Days</option>
                        <option value="30" selected>Last 30 Days</option>
                        <option value="90">Last 90 Days</option>
                        <option value="365">Last Year</option>
                    </select>
                </div>
            </div>
            <div style="display: flex; gap: 12px;">
                <button onclick="loadAllAnalytics()" class="btn btn-primary">Apply Filters</button>
                <button onclick="exportReport()" class="btn btn-success">Export Report</button>
            </div>
        </div>

        <!-- Dashboard Overview Stats -->
        <div class="stats-grid" id="overviewStats">
            <div class="stat-card">
                <h3>Total Bookings</h3>
                <div class="value" id="totalBookings">0</div>
                <div class="sub-value" id="bookingsGrowth">0% from previous period</div>
            </div>
            <div class="stat-card">
                <h3>Total Revenue</h3>
                <div class="value" id="totalRevenue">$0</div>
                <div class="sub-value" id="revenueGrowth">0% from previous period</div>
            </div>
            <div class="stat-card">
                <h3>Average Booking Value</h3>
                <div class="value" id="avgBookingValue">$0</div>
            </div>
            <div class="stat-card">
                <h3>Occupancy Rate</h3>
                <div class="value" id="occupancyRate">0%</div>
            </div>
        </div>

        <!-- Revenue Analytics -->
        <div class="card">
            <h2>ðŸ’° Revenue Analytics</h2>
            
            <div id="revenueLoading" class="loading">
                <div class="spinner"></div>
                <p style="margin-top: 16px;">Loading revenue data...</p>
            </div>

            <div id="revenueContent" style="display: none;">
                <h3>Revenue by Payment Status</h3>
                <div class="stats-grid" id="revenueByStatus"></div>

                <h3 style="margin-top: 24px;">Top Routes by Revenue</h3>
                <ul class="route-list" id="topRoutesList"></ul>
            </div>
        </div>

        <!-- Performance Metrics -->
        <div class="card">
            <h2>ðŸš€ Performance Metrics</h2>
            
            <div id="performanceLoading" class="loading">
                <div class="spinner"></div>
                <p style="margin-top: 16px;">Loading performance data...</p>
            </div>

            <div id="performanceContent" style="display: none;">
                <div class="two-column">
                    <div>
                        <h3>Most Popular Routes</h3>
                        <ul class="route-list" id="popularRoutesList"></ul>
                    </div>
                    <div>
                        <h3>Top Operators</h3>
                        <ul class="operator-list" id="topOperatorsList"></ul>
                    </div>
                </div>

                <h3 style="margin-top: 24px;">User Behavior Insights</h3>
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>Avg. Booking Lead Time</h3>
                        <div class="value" id="avgLeadTime">0</div>
                        <div class="sub-value">Days before departure</div>
                    </div>
                </div>

                <h3 style="margin-top: 24px;">Peak Booking Hours</h3>
                <table class="data-table" id="peakHoursTable">
                    <thead>
                        <tr>
                            <th>Hour</th>
                            <th>Bookings</th>
                            <th>Activity Level</th>
                        </tr>
                    </thead>
                    <tbody id="peakHoursBody"></tbody>
                </table>
            </div>
        </div>

        <!-- User Analytics -->
        <div class="card">
            <h2>ðŸ‘¥ User Analytics</h2>
            
            <div id="userLoading" class="loading">
                <div class="spinner"></div>
                <p style="margin-top: 16px;">Loading user data...</p>
            </div>

            <div id="userContent" style="display: none;">
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>Total Users</h3>
                        <div class="value" id="userTotalUsers">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Active Customers</h3>
                        <div class="value" id="userActiveCustomers">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>New Users</h3>
                        <div class="value" id="userNewUsers">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Conversion Rate</h3>
                        <div class="value" id="userConversionRate">0%</div>
                    </div>
                </div>

                <h3 style="margin-top: 24px;">Top Customers by Revenue</h3>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Username</th>
                            <th>Email</th>
                            <th>Total Spent</th>
                        </tr>
                    </thead>
                    <tbody id="topCustomersBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:5000/api';
        let currentDateFrom = null;
        let currentDateTo = null;
        let analyticsData = {};

        function showAlert(message, type) {
            const alertBox = document.getElementById('alert');
            alertBox.textContent = message;
            alertBox.className = `alert ${type}`;
            alertBox.style.display = 'block';
            setTimeout(() => {
                alertBox.style.display = 'none';
            }, 5000);
        }

        function getAuthHeaders() {
            const token = localStorage.getItem('access_token');
            return {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            };
        }

        function checkAuth() {
            const token = localStorage.getItem('access_token');
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            
            if (!token || user.role !== 'admin') {
                showAlert('Access denied. Admin privileges required.', 'error');
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 2000);
                return false;
            }
            return true;
        }

        function logout() {
            localStorage.removeItem('access_token');
            localStorage.removeItem('refresh_token');
            localStorage.removeItem('user');
            window.location.href = 'login.html';
        }

        function applyQuickSelect() {
            const days = parseInt(document.getElementById('quickSelect').value);
            if (!days) return;

            const today = new Date();
            const fromDate = new Date(today);
            fromDate.setDate(today.getDate() - days);

            document.getElementById('dateTo').value = formatDate(today);
            document.getElementById('dateFrom').value = formatDate(fromDate);
        }

        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function getDates() {
            const dateFrom = document.getElementById('dateFrom').value;
            const dateTo = document.getElementById('dateTo').value;
            
            return {
                dateFrom: dateFrom || formatDate(new Date(Date.now() - 30 * 24 * 60 * 60 * 1000)),
                dateTo: dateTo || formatDate(new Date())
            };
        }

        async function loadDashboardOverview() {
            const { dateFrom, dateTo } = getDates();
            
            try {
                const params = new URLSearchParams({
                    date_from: dateFrom,
                    date_to: dateTo
                });

                const response = await fetch(`${API_BASE_URL}/admin/analytics/dashboard?${params}`, {
                    headers: getAuthHeaders()
                });

                if (response.status === 401) {
                    showAlert('Session expired. Please login again.', 'error');
                    setTimeout(() => logout(), 2000);
                    return;
                }

                const data = await response.json();

                if (response.ok) {
                    analyticsData.dashboard = data;
                    displayDashboardOverview(data);
                } else {
                    showAlert(data.error || 'Failed to load dashboard overview', 'error');
                }
            } catch (error) {
                console.error('Error loading dashboard:', error);
                showAlert('Failed to load dashboard overview', 'error');
            }
        }

        function displayDashboardOverview(data) {
            document.getElementById('totalBookings').textContent = data.bookings.total;
            document.getElementById('bookingsGrowth').textContent = `${data.bookings.growth_percentage > 0 ? '+' : ''}${data.bookings.growth_percentage}% from previous period`;
            
            document.getElementById('totalRevenue').textContent = `$${parseFloat(data.revenue.total).toFixed(2)}`;
            document.getElementById('revenueGrowth').textContent = `${data.revenue.growth_percentage > 0 ? '+' : ''}${data.revenue.growth_percentage}% from previous period`;
            
            document.getElementById('avgBookingValue').textContent = `$${parseFloat(data.revenue.average_booking_value).toFixed(2)}`;
            document.getElementById('occupancyRate').textContent = `${data.seats.occupancy_rate}%`;

            // Apply growth styling
            const bookingsCard = document.getElementById('totalBookings').parentElement;
            const revenueCard = document.getElementById('totalRevenue').parentElement;
            
            if (data.bookings.growth_percentage > 0) {
                bookingsCard.classList.add('growth-positive');
            } else if (data.bookings.growth_percentage < 0) {
                bookingsCard.classList.add('growth-negative');
            }

            if (data.revenue.growth_percentage > 0) {
                revenueCard.classList.add('growth-positive');
            } else if (data.revenue.growth_percentage < 0) {
                revenueCard.classList.add('growth-negative');
            }
        }

        async function loadRevenueAnalytics() {
            const { dateFrom, dateTo } = getDates();
            
            document.getElementById('revenueLoading').style.display = 'block';
            document.getElementById('revenueContent').style.display = 'none';

            try {
                const params = new URLSearchParams({
                    date_from: dateFrom,
                    date_to: dateTo
                });

                const response = await fetch(`${API_BASE_URL}/admin/analytics/revenue?${params}`, {
                    headers: getAuthHeaders()
                });

                const data = await response.json();

                if (response.ok) {
                    analyticsData.revenue = data;
                    displayRevenueAnalytics(data);
                } else {
                    showAlert(data.error || 'Failed to load revenue analytics', 'error');
                }
            } catch (error) {
                console.error('Error loading revenue:', error);
                showAlert('Failed to load revenue analytics', 'error');
            } finally {
                document.getElementById('revenueLoading').style.display = 'none';
                document.getElementById('revenueContent').style.display = 'block';
            }
        }

        function displayRevenueAnalytics(data) {
            // Revenue by status
            const statusContainer = document.getElementById('revenueByStatus');
            statusContainer.innerHTML = '';
            
            Object.entries(data.revenue_by_status).forEach(([status, amount]) => {
                const card = document.createElement('div');
                card.className = 'stat-card';
                card.innerHTML = `
                    <h3>${status}</h3>
                    <div class="value">$${parseFloat(amount).toFixed(2)}</div>
                `;
                statusContainer.appendChild(card);
            });

            // Top routes
            const routesList = document.getElementById('topRoutesList');
            routesList.innerHTML = '';
            
            data.top_routes_by_revenue.forEach((route, index) => {
                const li = document.createElement('li');
                li.className = 'route-item';
                li.innerHTML = `
                    <div class="route-info">
                        <div class="route-name">${index + 1}. ${route.origin} â†’ ${route.destination}</div>
                        <div class="route-stats">${route.bookings} bookings</div>
                    </div>
                    <div class="route-revenue">$${parseFloat(route.revenue).toFixed(2)}</div>
                `;
                routesList.appendChild(li);
            });
        }

        async function loadPerformanceMetrics() {
            const { dateFrom, dateTo } = getDates();
            
            document.getElementById('performanceLoading').style.display = 'block';
            document.getElementById('performanceContent').style.display = 'none';

            try {
                const params = new URLSearchParams({
                    date_from: dateFrom,
                    date_to: dateTo
                });

                const response = await fetch(`${API_BASE_URL}/admin/analytics/performance?${params}`, {
                    headers: getAuthHeaders()
                });

                const data = await response.json();

                if (response.ok) {
                    analyticsData.performance = data;
                    displayPerformanceMetrics(data);
                } else {
                    showAlert(data.error || 'Failed to load performance metrics', 'error');
                }
            } catch (error) {
                console.error('Error loading performance:', error);
                showAlert('Failed to load performance metrics', 'error');
            } finally {
                document.getElementById('performanceLoading').style.display = 'none';
                document.getElementById('performanceContent').style.display = 'block';
            }
        }

        function displayPerformanceMetrics(data) {
            // Popular routes
            const popularList = document.getElementById('popularRoutesList');
            popularList.innerHTML = '';
            
            data.popular_routes.forEach((route, index) => {
                const li = document.createElement('li');
                li.className = 'route-item';
                li.innerHTML = `
                    <div class="route-info">
                        <div class="route-name">${index + 1}. ${route.origin} â†’ ${route.destination}</div>
                        <div class="route-stats">${route.bookings} bookings â€¢ ${route.seats_sold} seats</div>
                    </div>
                    <div class="route-revenue">$${parseFloat(route.avg_fare).toFixed(2)}</div>
                `;
                popularList.appendChild(li);
            });

            // Top operators
            const operatorsList = document.getElementById('topOperatorsList');
            operatorsList.innerHTML = '';
            
            data.top_operators.forEach((op, index) => {
                const li = document.createElement('li');
                li.className = 'operator-item';
                li.innerHTML = `
                    <div class="operator-info">
                        <div class="operator-name">${index + 1}. ${op.operator_name}</div>
                        <div class="operator-stats">${op.bookings} bookings â€¢ ${op.trip_count} trips</div>
                    </div>
                    <div class="operator-revenue">$${parseFloat(op.revenue).toFixed(2)}</div>
                `;
                operatorsList.appendChild(li);
            });

            // Lead time
            document.getElementById('avgLeadTime').textContent = data.average_booking_lead_time_days;

            // Peak hours
            const tbody = document.getElementById('peakHoursBody');
            tbody.innerHTML = '';
            
            const maxBookings = Math.max(...data.peak_booking_hours.map(h => h.booking_count));
            
            data.peak_booking_hours.forEach(hour => {
                const percentage = (hour.booking_count / maxBookings) * 100;
                let level = 'Low';
                let levelClass = '';
                
                if (percentage > 75) {
                    level = 'High';
                    levelClass = 'badge-primary';
                } else if (percentage > 40) {
                    level = 'Medium';
                    levelClass = 'badge-primary';
                }
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${hour.hour}:00</td>
                    <td>${hour.booking_count}</td>
                    <td><span class="badge ${levelClass}">${level}</span></td>
                `;
                tbody.appendChild(row);
            });
        }

        async function loadUserAnalytics() {
            const { dateFrom, dateTo } = getDates();
            
            document.getElementById('userLoading').style.display = 'block';
            document.getElementById('userContent').style.display = 'none';

            try {
                const params = new URLSearchParams({
                    date_from: dateFrom,
                    date_to: dateTo
                });

                const response = await fetch(`${API_BASE_URL}/admin/analytics/users?${params}`, {
                    headers: getAuthHeaders()
                });

                const data = await response.json();

                if (response.ok) {
                    analyticsData.users = data;
                    displayUserAnalytics(data);
                } else {
                    showAlert(data.error || 'Failed to load user analytics', 'error');
                }
            } catch (error) {
                console.error('Error loading users:', error);
                showAlert('Failed to load user analytics', 'error');
            } finally {
                document.getElementById('userLoading').style.display = 'none';
                document.getElementById('userContent').style.display = 'block';
            }
        }

        function displayUserAnalytics(data) {
            const overview = data.overview;
            document.getElementById('userTotalUsers').textContent = (overview.users_by_role.customer || 0) + (overview.users_by_role.admin || 0);
            document.getElementById('userActiveCustomers').textContent = overview.active_users;
            document.getElementById('userNewUsers').textContent = data.new_users_trend.reduce((sum, item) => sum + item.user_count, 0);
            document.getElementById('userConversionRate').textContent = `${overview.conversion_rate}%`;

            // Top customers
            const tbody = document.getElementById('topCustomersBody');
            tbody.innerHTML = '';
            
            data.top_customers_by_revenue.slice(0, 10).forEach(customer => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${customer.username}</strong></td>
                    <td>${customer.email}</td>
                    <td><strong>$${parseFloat(customer.total_spent).toFixed(2)}</strong></td>
                `;
                tbody.appendChild(row);
            });
        }

        async function loadAllAnalytics() {
            if (!checkAuth()) return;

            await Promise.all([
                loadDashboardOverview(),
                loadRevenueAnalytics(),
                loadPerformanceMetrics(),
                loadUserAnalytics()
            ]);

            showAlert('Analytics loaded successfully', 'success');
        }

        function exportReport() {
            const reportData = {
                generated_at: new Date().toISOString(),
                period: getDates(),
                analytics: analyticsData
            };

            const dataStr = JSON.stringify(reportData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `tickethub-analytics-${formatDate(new Date())}.json`;
            link.click();
            
            URL.revokeObjectURL(url);
            showAlert('Report exported successfully', 'success');
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            if (checkAuth()) {
                // Set default dates
                applyQuickSelect();
                loadAllAnalytics();
            }
        });
    </script>
</body>
</html>

