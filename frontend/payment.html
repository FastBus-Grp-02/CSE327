<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment - FastBus</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #8b5cf6;
            --success: #10b981;
            --error: #ef4444;
            --text: #1f2937;
            --text-light: #6b7280;
            --bg: #f9fafb;
            --white: #ffffff;
            --border: #e5e7eb;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: var(--text);
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .header {
            background: var(--white);
            padding: 20px 30px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .logo {
            font-size: 24px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .secure-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--success);
            font-size: 14px;
            font-weight: 600;
        }

        .progress-steps {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .step {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            background: var(--bg);
            color: var(--text-light);
        }

        .step.active {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: var(--white);
        }

        .card {
            background: var(--white);
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .card-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--text);
        }

        .payment-methods {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .payment-method {
            padding: 20px;
            border: 2px solid var(--border);
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: var(--bg);
        }

        .payment-method:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
        }

        .payment-method.active {
            border-color: var(--primary);
            background: rgba(99, 102, 241, 0.1);
        }

        .payment-method-icon {
            font-size: 32px;
            margin-bottom: 10px;
        }

        .payment-method-name {
            font-size: 14px;
            font-weight: 600;
            color: var(--text);
        }

        .payment-form {
            display: none;
        }

        .payment-form.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            color: var(--text);
            margin-bottom: 8px;
        }

        input, select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 15px;
            transition: all 0.3s ease;
            background: var(--bg);
            font-family: inherit;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--primary);
            background: var(--white);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .payment-summary {
            background: var(--bg);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            font-size: 14px;
        }

        .summary-row.total {
            font-size: 24px;
            font-weight: 700;
            padding-top: 12px;
            border-top: 2px solid var(--border);
            margin-top: 12px;
            color: var(--primary);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: var(--white);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(99, 102, 241, 0.3);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-full {
            width: 100%;
            padding: 16px;
            font-size: 16px;
        }

        .test-payment-notice {
            background: #fef3c7;
            border: 2px solid #fbbf24;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
            color: #92400e;
        }

        .test-scenarios {
            margin-top: 10px;
            font-size: 13px;
        }

        .test-scenarios div {
            margin-top: 5px;
        }

        .alert {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
            display: none;
        }

        .alert.error {
            background: #fee2e2;
            color: var(--error);
            border: 1px solid #fecaca;
        }

        .alert.success {
            background: #d1fae5;
            color: var(--success);
            border: 1px solid #a7f3d0;
        }

        .loading {
            display: inline-block;
            width: 14px;
            height: 14px;
            border: 2px solid var(--white);
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 0.8s linear infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .payment-methods {
                grid-template-columns: repeat(2, 1fr);
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .header {
                flex-direction: column;
                gap: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">FastBus</div>
            <div class="secure-badge">
                <span>üîí</span>
                <span>Secure Payment</span>
            </div>
        </div>

        <div class="progress-steps">
            <div class="step">1. Trip Details</div>
            <div class="step">2. Passenger Info</div>
            <div class="step active">3. Payment</div>
        </div>

        <div id="alert" class="alert"></div>

        <div class="card">
            <div class="test-payment-notice">
                <strong>üß™ Test Payment Mode</strong>
                <div class="test-scenarios">
                    <div>‚úÖ Card ending in 1111 - Success</div>
                    <div>‚ùå Card ending in 0000 - Failure</div>
                    <div>üí∞ Any MFS ID or account number works</div>
                </div>
            </div>

            <div class="payment-summary">
                <div class="summary-row">
                    <span>Booking ID</span>
                    <strong id="bookingId">---</strong>
                </div>
                <div class="summary-row total">
                    <span>Amount to Pay</span>
                    <span id="totalAmount">‡ß≥0</span>
                </div>
            </div>

            <h2 class="card-title">Select Payment Method</h2>
            <div class="payment-methods">
                <div class="payment-method" data-method="card" onclick="selectPaymentMethod('card')">
                    <div class="payment-method-icon">üí≥</div>
                    <div class="payment-method-name">Card</div>
                </div>
                <div class="payment-method" data-method="upi" onclick="selectPaymentMethod('upi')">
                    <div class="payment-method-icon">üì±</div>
                    <div class="payment-method-name">MFS</div>
                </div>
                <div class="payment-method" data-method="netbanking" onclick="selectPaymentMethod('netbanking')">
                    <div class="payment-method-icon">üè¶</div>
                    <div class="payment-method-name">Net Banking</div>
                </div>
                <div class="payment-method" data-method="wallet" onclick="selectPaymentMethod('wallet')">
                    <div class="payment-method-icon">üëõ</div>
                    <div class="payment-method-name">Wallet</div>
                </div>
            </div>

            <!-- Card Payment Form -->
            <form class="payment-form" id="cardForm">
                <h3 class="card-title" style="font-size: 16px;">Card Details</h3>
                <div class="form-group">
                    <label for="cardNumber">Card Number *</label>
                    <input type="text" id="cardNumber" placeholder="1234 5678 9012 3456" maxlength="19" required>
                </div>
                <div class="form-group">
                    <label for="cardName">Cardholder Name *</label>
                    <input type="text" id="cardName" placeholder="Name on card" required>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="expiryDate">Expiry Date *</label>
                        <input type="text" id="expiryDate" placeholder="MM/YY" maxlength="5" required>
                    </div>
                    <div class="form-group">
                        <label for="cvv">CVV *</label>
                        <input type="text" id="cvv" placeholder="123" maxlength="3" required>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary btn-full">Pay Now</button>
            </form>

            <!-- UPI Payment Form -->
            <form class="payment-form" id="upiForm">
                <h3 class="card-title" style="font-size: 16px;">UPI Details</h3>
                <div class="form-group">
                    <label for="upiId">UPI ID *</label>
                    <input type="text" id="upiId" placeholder="yourname@upi" required>
                </div>
                <button type="submit" class="btn btn-primary btn-full">Pay Now</button>
            </form>

            <!-- Net Banking Form -->
            <form class="payment-form" id="netbankingForm">
                <h3 class="card-title" style="font-size: 16px;">Net Banking Details</h3>
                <div class="form-group">
                    <label for="bankName">Select Bank *</label>
                    <select id="bankName" required>
                        <option value="">Choose your bank</option>
                        <option value="DB">Dhaka Bank</option>
                        <option value="UCB">United Commertial Bank</option>
                        <option value="NCCB">NCC Bank</option>
                        <option value="EXIMB">EXIM Bank</option>
                        <option value="SEB">South East Bank</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary btn-full">Proceed to Bank</button>
            </form>

            <!-- Wallet Form -->
            <form class="payment-form" id="walletForm">
                <h3 class="card-title" style="font-size: 16px;">Digital Wallet</h3>
                <div class="form-group">
                    <label for="walletType">Select Wallet *</label>
                    <select id="walletType" required>
                        <option value="">Choose your wallet</option>
                        <option value="Paypal">Paypal</option>
                        <option value="Apple Pay">Apple Pay</option>
                        <option value="Google Pay">Google Pay</option>
                        <option value="Bitcoin">Bitcoin</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="walletPhone">Registered Mobile Number *</label>
                    <input type="tel" id="walletPhone" placeholder="+91 9876543210" required>
                </div>
                <button type="submit" class="btn btn-primary btn-full">Pay with Wallet</button>
            </form>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:5000/api';
        let bookingId = null;
        let totalAmount = 0;

        function showAlert(message, type) {
            const alertBox = document.getElementById('alert');
            alertBox.textContent = message;
            alertBox.className = `alert ${type}`;
            alertBox.style.display = 'block';
            setTimeout(() => alertBox.style.display = 'none', 5000);
        }

        function loadBookingInfo() {
            // Get booking ID from URL or session
            const params = new URLSearchParams(window.location.search);
            bookingId = params.get('booking_id') || sessionStorage.getItem('bookingId');

            if (!bookingId) {
                showAlert('No booking ID found', 'error');
                setTimeout(() => window.location.href = 'search.html', 2000);
                return;
            }

            document.getElementById('bookingId').textContent = bookingId;

            // Calculate total amount from booking data
            const bookingData = JSON.parse(sessionStorage.getItem('bookingData') || '{}');
            if (bookingData.trip) {
                let baseFare = bookingData.trip.base_fare;
                if (bookingData.selectedClass === 'business') baseFare *= 1.5;
                if (bookingData.selectedClass === 'first') baseFare *= 2;

                totalAmount = baseFare;
                if (bookingData.appliedPromo) {
                    const discount = (totalAmount * bookingData.appliedPromo.discount_percent) / 100;
                    totalAmount -= discount;
                }

                document.getElementById('totalAmount').textContent = `‡ß≥${totalAmount.toFixed(2)}`;
            }
        }

        function selectPaymentMethod(method) {
            // Update active state
            document.querySelectorAll('.payment-method').forEach(el => el.classList.remove('active'));
            document.querySelector(`[data-method="${method}"]`).classList.add('active');

            // Show corresponding form
            document.querySelectorAll('.payment-form').forEach(form => form.classList.remove('active'));
            document.getElementById(`${method}Form`).classList.add('active');
        }

        function formatCardNumber(input) {
            let value = input.value.replace(/\s/g, '');
            let formattedValue = value.match(/.{1,4}/g)?.join(' ') || value;
            input.value = formattedValue;
        }

        function formatExpiryDate(input) {
            let value = input.value.replace(/\D/g, '');
            if (value.length >= 2) {
                value = value.slice(0, 2) + '/' + value.slice(2, 4);
            }
            input.value = value;
        }

        async function processPayment(paymentMethod, paymentDetails) {
            const paymentPayload = {
                booking_id: parseInt(bookingId),
                payment_method: paymentMethod,
                payment_details: paymentDetails
            };

            try {
                const token = localStorage.getItem('access_token');
                const headers = {
                    'Content-Type': 'application/json'
                };

                if (token) {
                    headers['Authorization'] = `Bearer ${token}`;
                }

                // Step 1: Initiate payment
                const initiateResponse = await fetch(`${API_BASE_URL}/payments/initiate`, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(paymentPayload)
                });

                const initiateData = await initiateResponse.json();

                if (!initiateResponse.ok) {
                    showAlert(initiateData.error || 'Failed to initiate payment', 'error');
                    return false;
                }

                const paymentId = initiateData.payment.id;
                
                // Step 2: Process payment (simulate processing)
                const processResponse = await fetch(`${API_BASE_URL}/payments/${paymentId}/process`, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify({ test_scenario: 'success' })
                });

                const processData = await processResponse.json();

                if (processResponse.ok) {
                    showAlert('Payment successful!', 'success');
                    
                    // Store booking reference
                    const bookingReference = processData.payment.booking_reference || bookingId;
                    sessionStorage.setItem('bookingReference', bookingReference);
                    sessionStorage.setItem('paymentData', JSON.stringify(processData.payment));
                    
                    // Redirect to confirmation page
                    setTimeout(() => {
                        window.location.href = `booking-confirmation.html?reference=${bookingReference}`;
                    }, 1500);
                } else {
                    showAlert(processData.error || 'Payment failed. Please try again.', 'error');
                    return false;
                }
            } catch (error) {
                console.error('Payment error:', error);
                showAlert('Payment processing failed. Please try again.', 'error');
                return false;
            }

            return true;
        }

        // Card Form Handler
        document.getElementById('cardForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button');
            btn.disabled = true;
            btn.innerHTML = 'Processing...<span class="loading"></span>';

            const cardNumber = document.getElementById('cardNumber').value.replace(/\s/g, '');
            const paymentDetails = {
                card_number: cardNumber,
                card_holder: document.getElementById('cardName').value,
                expiry_date: document.getElementById('expiryDate').value,
                cvv: document.getElementById('cvv').value
            };

            const success = await processPayment('credit_card', paymentDetails);
            
            if (!success) {
                btn.disabled = false;
                btn.textContent = 'Pay Now';
            }
        });

        // UPI Form Handler
        document.getElementById('upiForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button');
            btn.disabled = true;
            btn.innerHTML = 'Processing...<span class="loading"></span>';

            const paymentDetails = {
                upi_id: document.getElementById('upiId').value
            };

            const success = await processPayment('upi', paymentDetails);
            
            if (!success) {
                btn.disabled = false;
                btn.textContent = 'Pay Now';
            }
        });

        // Net Banking Form Handler
        document.getElementById('netbankingForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button');
            btn.disabled = true;
            btn.innerHTML = 'Processing...<span class="loading"></span>';

            const paymentDetails = {
                bank_name: document.getElementById('bankName').value
            };

            const success = await processPayment('net_banking', paymentDetails);
            
            if (!success) {
                btn.disabled = false;
                btn.textContent = 'Proceed to Bank';
            }
        });

        // Wallet Form Handler
        document.getElementById('walletForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button');
            btn.disabled = true;
            btn.innerHTML = 'Processing...<span class="loading"></span>';

            const paymentDetails = {
                wallet_type: document.getElementById('walletType').value,
                phone: document.getElementById('walletPhone').value
            };

            const success = await processPayment('digital_wallet', paymentDetails);
            
            if (!success) {
                btn.disabled = false;
                btn.textContent = 'Pay with Wallet';
            }
        });

        // Input formatters
        document.getElementById('cardNumber').addEventListener('input', (e) => formatCardNumber(e.target));
        document.getElementById('expiryDate').addEventListener('input', (e) => formatExpiryDate(e.target));
        document.getElementById('cvv').addEventListener('input', (e) => {
            e.target.value = e.target.value.replace(/\D/g, '').slice(0, 3);
        });

        // Load booking info on page load
        loadBookingInfo();
    </script>
</body>
</html>

